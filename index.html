<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位書櫃：視覺化教學資源網</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Noto Serif & Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* 平滑滾動與基礎動畫 */
        html { scroll-behavior: smooth; }

        /* 圖片比例 */
        .book-card-aspect { aspect-ratio: 2/3; }

        /* 音樂波紋動畫 */
        .music-bar {
            width: 2px;
            height: 12px;
            background: #fde68a;
            margin: 0 1px;
            animation: music-wave 1s ease-in-out infinite;
            display: inline-block;
        }
        .music-bar:nth-child(2) { animation-delay: 0.2s; }
        .music-bar:nth-child(3) { animation-delay: 0.4s; }
        @keyframes music-wave {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }

        /* 進入頁面覆蓋層 */
        #entrance-overlay {
            background-image: radial-gradient(circle at center, #1c1917 0%, #0c0a09 100%);
        }

        /* 內容滾動條樣式優化 */
        #modal-content-area {
            scrollbar-gutter: stable;
        }
        #modal-content-area::-webkit-scrollbar {
            width: 10px;
        }
        #modal-content-area::-webkit-scrollbar-track {
            background: #f5f5f4;
        }
        #modal-content-area::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 10px;
            border: 3px solid #f5f5f4;
        }
        #modal-content-area::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 transition-colors duration-500 overflow-x-hidden">

    <!-- 進入頁面門檻 -->
    <div id="entrance-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center text-white px-6 text-center">
        <div class="mb-12 animate-in fade-in zoom-in duration-1000">
            <i data-lucide="book-marked" class="w-16 h-16 mx-auto mb-6 text-amber-200/60"></i>
            <h1 class="text-4xl md:text-7xl font-serif font-bold tracking-[0.3em] mb-4">數位書櫃</h1>
            <p class="text-stone-500 tracking-[0.5em] font-light text-xs md:text-lg uppercase">Visualized Teaching Resources</p>
        </div>
        <button id="start-btn" class="group relative px-12 py-5 bg-white/5 hover:bg-white/10 border border-white/20 rounded-full overflow-hidden transition-all hover:scale-105 active:scale-95 shadow-2xl">
            <span class="relative z-10 text-xl tracking-[0.4em] font-serif group-hover:text-amber-200 transition-colors">開啟書卷，靜心閱讀</span>
            <div class="absolute inset-0 bg-gradient-to-r from-amber-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </button>
        
        <div class="mt-8 flex flex-col items-center gap-5">
            <p class="text-stone-600 text-xs tracking-widest animate-pulse italic">點擊開啟沉浸式配樂空間</p>
            
            <!-- 新增：複製網址與無痕模式提示按鈕 -->
            <button id="copy-link-btn" class="flex items-center gap-2 text-stone-400 hover:text-amber-200 transition-colors text-xs md:text-sm font-light tracking-widest border border-stone-800 hover:border-amber-200/50 rounded-full px-6 py-2.5 bg-stone-900/50 backdrop-blur-sm active:scale-95">
                <i data-lucide="copy" class="w-4 h-4"></i>
                <span id="copy-link-text">複製網址 (若資料未更新，建議以無痕模式開啟)</span>
            </button>
        </div>
    </div>

    <!-- 載入中畫面 -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-stone-50 hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin mb-4"></div>
        <p class="font-serif tracking-widest text-lg text-stone-600 font-bold italic">墨香渲染中...</p>
    </div>

    <!-- 音訊資源 -->
    <audio id="bg-music" loop preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2025/06/06/audio_cd7be0eafc.mp3?filename=tunetank-ambient-piano-music-348968.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-page" preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2025/11/25/audio_26e276330f.mp3?filename=spinopel-turn-the-page-of-a-book-442331.mp3" type="audio/mpeg">
    </audio>

    <!-- Hero Section -->
    <section id="hero" class="relative h-[65vh] md:h-[85vh] flex items-center justify-center overflow-hidden bg-stone-900 text-white">
        <div id="hero-image" class="absolute inset-0 opacity-30 bg-cover bg-center blur-sm scale-105 transition-all duration-1000"></div>
        <div class="relative z-10 text-center px-6 max-w-6xl">
            <i data-lucide="sparkles" class="mx-auto mb-4 md:mb-6 text-amber-200 opacity-80 w-6 h-6 md:w-10 md:h-10"></i>
            <h2 id="hero-quote" class="text-xl md:text-5xl font-serif italic mb-8 md:mb-14 leading-relaxed tracking-wide px-4"></h2>
            <div class="h-px w-16 md:w-32 bg-amber-200 mx-auto mb-8 opacity-50"></div>
            <p id="hero-book" class="text-stone-300 font-light tracking-[0.2em] text-sm md:text-2xl mb-12"></p>
            
            <div class="flex flex-wrap items-center justify-center gap-6">
                <button id="music-toggle" class="inline-flex items-center gap-3 px-10 py-4 bg-amber-200/10 hover:bg-amber-200/20 backdrop-blur-md border border-amber-200/30 rounded-full text-sm md:text-lg tracking-[0.2em] transition-all hover:scale-105 active:scale-95 group">
                    <div id="music-bars" class="hidden flex items-end h-5">
                        <span class="music-bar"></span>
                        <span class="music-bar"></span>
                        <span class="music-bar"></span>
                    </div>
                    <i id="music-icon" data-lucide="music" class="w-5 h-5 text-amber-200"></i>
                    <span id="music-text">暫停音樂</span>
                </button>
            </div>
        </div>
    </section>

    <!-- 控制列 -->
    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-stone-200 shadow-sm">
        <div class="max-w-[1600px] mx-auto flex flex-col gap-4 p-4 md:p-8">
            <div class="flex flex-col md:flex-row gap-6 items-center justify-between">
                <div class="relative w-full md:w-[500px]">
                    <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 text-stone-400 w-6 h-6"></i>
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="搜尋書名、作者、金句或教學單元..."
                        class="w-full pl-16 pr-6 py-4 bg-stone-100 border-transparent focus:bg-white border focus:border-stone-300 rounded-2xl focus:outline-none transition-all text-base md:text-xl appearance-none shadow-inner"
                    >
                </div>
            </div>
            
            <div class="flex items-center gap-3 overflow-x-auto no-scrollbar py-2">
                <i data-lucide="filter" class="text-stone-400 flex-shrink-0 w-5 h-5 mr-2 hidden md:block"></i>
                <div id="filter-container" class="flex gap-4"></div>
            </div>
        </div>
    </div>

    <!-- 書籍網格 -->
    <main class="max-w-[1600px] mx-auto px-6 mt-10 mb-32">
        <div id="book-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8 md:gap-16"></div>
        <div id="empty-state" class="hidden py-40 text-center text-stone-400">
            <i data-lucide="book-open" class="mx-auto mb-6 opacity-20 w-24 h-24"></i>
            <p class="text-2xl font-light">未找到符合條件的內容</p>
        </div>
    </main>

    <!-- 超大詳情彈窗 -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-0 md:p-2 lg:p-4">
        <div id="modal-overlay" class="absolute inset-0 bg-stone-900/95 backdrop-blur-2xl"></div>
        
        <!-- Modal 容器：手機版為 flex-col (直向), 電腦版為 flex-row (橫向) -->
        <div class="relative bg-white w-full h-full md:w-[98vw] md:h-[96vh] md:rounded-[3rem] overflow-hidden shadow-[0_0_120px_rgba(0,0,0,0.6)] animate-in zoom-in-95 duration-500 flex flex-col md:flex-row">
            
            <!-- 關閉按鈕：手機版縮小並調整位置 -->
            <button id="modal-close" class="absolute top-4 right-4 md:top-6 md:right-6 z-50 p-3 md:p-5 bg-stone-900/40 hover:bg-stone-900/60 md:bg-stone-900/20 md:hover:bg-stone-900/40 rounded-full text-white backdrop-blur-xl transition-all shadow-2xl">
                <i data-lucide="x" class="w-6 h-6 md:w-12 md:h-12"></i>
            </button>
            
            <!-- 左側封面圖 / 手機版上方 Banner -->
            <!-- 手機版: 高度 30vh, 電腦版: 寬度 35% -->
            <div class="relative w-full h-[30vh] md:h-full md:w-[35%] bg-stone-200 flex-shrink-0">
                <!-- 手機版的上方漸層陰影，確保關閉按鈕即使在明亮的圖片上也能看清楚 -->
                <div class="absolute inset-x-0 top-0 h-24 bg-gradient-to-b from-stone-900/60 to-transparent md:hidden z-10 pointer-events-none"></div>
                <img id="modal-cover" src="" alt="" class="w-full h-full object-cover object-top md:object-center shadow-2xl relative z-0">
            </div>

            <!-- 右側內容區塊 / 手機版下方內容 -->
            <!-- 手機版: flex-1 填滿剩餘空間 (解決 h-full 導致的滾動溢出問題) -->
            <div id="modal-content-area" class="w-full flex-1 md:w-[65%] md:h-full p-6 md:p-24 overflow-y-auto bg-stone-50">
                <div class="mb-10 md:mb-20">
                    <span id="modal-unit" class="text-amber-600 text-sm md:text-2xl font-bold tracking-[0.4em] uppercase mb-4 md:mb-6 block"></span>
                    <h2 id="modal-title" class="text-3xl md:text-6xl font-serif font-bold text-stone-900 mb-4 md:mb-6 leading-[1.2]"></h2>
                    <div class="flex flex-wrap items-center gap-6 md:gap-12 text-stone-400 text-sm md:text-3xl font-light mb-8 md:mb-10">
                        <span class="flex items-center gap-2 md:gap-4"><i data-lucide="user" class="w-5 h-5 md:w-10 md:h-10 opacity-30"></i> <span id="modal-author" class="text-stone-600"></span></span>
                        <span class="flex items-center gap-2 md:gap-4"><i data-lucide="calendar" class="w-5 h-5 md:w-10 md:h-10 opacity-30"></i> <span id="modal-year" class="text-stone-600"></span></span>
                    </div>

                    <!-- 外部連結按鈕區塊 (導讀 & 練習題) -->
                    <div class="flex flex-wrap gap-4">
                        <!-- 深度導讀按鈕區塊 -->
                        <div id="modal-deep-dive-container" class="hidden">
                            <a id="modal-deep-dive-link" href="#" target="_blank" class="inline-flex items-center gap-3 md:gap-4 px-6 md:px-8 py-3 md:py-4 bg-stone-800 hover:bg-stone-700 text-white rounded-xl md:rounded-2xl text-base md:text-2xl font-bold transition-all shadow-xl active:scale-95 group">
                                <i data-lucide="external-link" class="w-5 h-5 md:w-8 md:h-8 group-hover:text-amber-200 transition-colors"></i>
                                閱讀深度導讀
                            </a>
                        </div>
                        
                        <!-- 練習題按鈕區塊 (新增) -->
                        <div id="modal-exercise-container" class="hidden">
                            <a id="modal-exercise-link" href="#" target="_blank" class="inline-flex items-center gap-3 md:gap-4 px-6 md:px-8 py-3 md:py-4 bg-amber-600 hover:bg-amber-500 text-white rounded-xl md:rounded-2xl text-base md:text-2xl font-bold transition-all shadow-xl active:scale-95 group">
                                <i data-lucide="pen-tool" class="w-5 h-5 md:w-8 md:h-8 group-hover:text-amber-100 transition-colors"></i>
                                進入練習題
                            </a>
                        </div>
                    </div>
                </div>

                <div class="space-y-16 md:space-y-32 text-stone-700 pb-12 md:pb-20 mt-10 md:mt-20">
                    <div class="relative p-8 md:p-24 bg-white rounded-3xl md:rounded-[4rem] border-l-[12px] md:border-l-[24px] border-stone-800 shadow-2xl italic group overflow-hidden">
                        <i data-lucide="quote" class="absolute -top-6 -left-6 md:-top-12 md:-left-10 text-stone-50 w-32 h-32 md:w-64 md:h-64 opacity-60"></i>
                        <p id="modal-quote" class="leading-[1.6] font-serif text-xl md:text-4xl relative z-10 text-stone-800"></p>
                    </div>

                    <section>
                        <h4 class="flex items-center gap-4 md:gap-6 text-stone-900 font-bold mb-6 md:mb-10 border-b-4 border-stone-200 pb-4 md:pb-6 text-xl md:text-4xl">
                            <i data-lucide="sparkles" class="text-amber-500 w-6 h-6 md:w-14 md:h-14"></i> 核心論點
                        </h4>
                        <p id="modal-argument" class="text-lg md:text-3xl leading-[2] text-stone-600 font-light"></p>
                    </section>

                    <div class="space-y-12 md:space-y-24">
                        <section>
                            <h4 class="text-stone-900 font-bold mb-4 md:mb-8 text-xs md:text-xl uppercase tracking-[0.5em] opacity-30">理論架構 / 研究方法</h4>
                            <p id="modal-framework" class="text-base md:text-3xl leading-[1.8] text-stone-600 bg-stone-200/40 p-6 md:p-14 rounded-3xl md:rounded-[3rem] border border-stone-200/50"></p>
                        </section>
                        <section>
                            <h4 class="text-stone-900 font-bold mb-4 md:mb-8 text-xs md:text-xl uppercase tracking-[0.5em] opacity-30">學術定位</h4>
                            <p id="modal-position" class="text-base md:text-3xl leading-[1.8] text-stone-600 bg-stone-200/40 p-6 md:p-14 rounded-3xl md:rounded-[3rem] border border-stone-200/50"></p>
                        </section>
                    </div>

                    <section class="bg-amber-50 p-8 md:p-24 rounded-3xl md:rounded-[4rem] border border-amber-100 shadow-inner">
                        <h4 class="flex items-center gap-4 md:gap-8 text-amber-900 font-bold mb-6 md:mb-12 text-2xl md:text-5xl">
                            <i data-lucide="graduation-cap" class="text-amber-700 w-8 h-8 md:w-20 md:h-20"></i> 教學應用建議
                        </h4>
                        <p id="modal-teaching" class="text-lg md:text-3xl leading-[2] whitespace-pre-wrap text-stone-800 font-normal"></p>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增：外部連結提示彈窗 (防 LINE 白畫面/無痕提示) -->
    <div id="external-link-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 md:p-0">
        <div id="external-link-overlay" class="absolute inset-0 bg-stone-900/80 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-[2rem] p-8 md:p-10 max-w-md w-full shadow-2xl animate-in zoom-in-95 text-center">
            <i data-lucide="alert-circle" class="w-16 h-16 text-amber-500 mx-auto mb-6"></i>
            <h3 id="external-link-title" class="text-2xl font-serif font-bold text-stone-900 mb-4">即將開啟外部連結</h3>
            <p class="text-stone-600 text-sm md:text-base mb-8 leading-relaxed">
                若您目前使用 <strong class="text-stone-900">LINE</strong> 等內建瀏覽器，可能會遇到無法正常載入的問題。<br><br>
                建議您點擊 <strong class="text-amber-600">複製網址</strong>，並切換至 Safari / Chrome 的<strong class="text-amber-600">無痕模式</strong>開啟，以獲得最佳體驗。
            </p>
            <div class="flex flex-col gap-4">
                <button id="btn-copy-deep-link" class="w-full py-4 bg-amber-100 text-amber-800 font-bold rounded-2xl hover:bg-amber-200 transition-colors flex items-center justify-center gap-3 text-lg">
                    <i data-lucide="copy" class="w-5 h-5"></i>
                    <span>複製網址</span>
                </button>
                <button id="btn-continue-link" class="w-full py-4 bg-stone-800 text-white font-bold rounded-2xl hover:bg-stone-700 transition-colors text-lg">
                    仍要直接開啟
                </button>
                <button id="btn-cancel-link" class="w-full py-3 text-stone-400 hover:text-stone-600 font-bold rounded-2xl transition-colors mt-2">
                    取消
                </button>
            </div>
        </div>
    </div>

    <button id="back-to-top" class="fixed bottom-6 right-6 md:bottom-12 md:right-12 z-30 p-4 md:p-6 bg-stone-800 text-white rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none hover:bg-stone-700">
        <i data-lucide="arrow-up" class="w-8 h-8 md:w-10 md:h-10"></i>
    </button>

    <footer class="py-20 md:py-40 border-t border-stone-200 text-center text-stone-400 bg-stone-100/50">
        <div class="flex flex-col items-center gap-8 md:gap-12">
            <p class="text-sm md:text-lg tracking-[0.5em] font-light uppercase">數位書櫃：視覺化教學資源系統</p>
        </div>
    </footer>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_cqaP-vZr1MW-RYFmbWsCD9FKEwRDXq8lHjI12Sl5z0VwfnvQgurnhE3PDVXrK1cqMRhaMLKVx9XG/pub?gid=1650364862&single=true&output=csv";
        
        let allBooks = [];
        // 改用 Set 來儲存多選的類別
        let selectedCategories = new Set(); 
        let currentSearch = '';

        const bgMusic = document.getElementById('bg-music');
        const pageSfx = document.getElementById('sfx-page');
        const musicToggle = document.getElementById('music-toggle');
        const musicIcon = document.getElementById('music-icon');
        const musicText = document.getElementById('music-text');
        const musicBars = document.getElementById('music-bars');
        let isPlaying = false;

        const initIcons = () => lucide.createIcons();
        const playPageSfx = () => { pageSfx.currentTime = 0; pageSfx.play().catch(() => {}); };

        function robustCSVParse(text) {
            const rows = [];
            let currentField = '';
            let currentRow = [];
            let inQuotes = false;
            const normalizedText = text.replace(/\r\n/g, '\n');

            for (let i = 0; i < normalizedText.length; i++) {
                const char = normalizedText[i];
                const nextChar = normalizedText[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentField += '"'; i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentField);
                        currentField = '';
                    } else if (char === '\n') {
                        currentRow.push(currentField);
                        if (currentRow.length > 1 || currentRow[0] !== '') {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
            }
            if (currentRow.length > 0 || currentField !== '') {
                currentRow.push(currentField);
                rows.push(currentRow);
            }
            return rows.slice(1);
        }

        async function loadData() {
            document.getElementById('loading-screen').classList.remove('hidden');
            try {
                const response = await fetch(SHEET_CSV_URL);
                const text = await response.text();
                const data = robustCSVParse(text);

                // 確保這裡讀取到第 13 欄（陣列索引 12，為 M 欄位「所屬分類」）
                allBooks = data.map((row, index) => ({
                    id: index,
                    title: row[0] || '未知書名',
                    author: row[1] || '未知作者',
                    year: row[2] || '',
                    coreArgument: row[3] || '',
                    quote: row[4] || '',
                    framework: row[5] || '',
                    position: row[6] || '',
                    teachingUnit: row[7] || '未分類',
                    teachingApp: row[8] || '',
                    cover: row[9] || 'https://images.unsplash.com/photo-1543004218-ee141104975a?auto=format&fit=crop&q=80&w=400',
                    deepDive: row[10] || '', // K欄位：讀取網址
                    exerciseLink: row[11] || '', // L欄位：練習題連結
                    category: row[12] || '未分類' // M欄位：所屬分類
                }));

                setupHero();
                setupFilters();
                renderBooks();
                document.getElementById('loading-screen').classList.add('hidden');
            } catch (error) {
                console.error("Data Fetch Error:", error);
                document.getElementById('loading-screen').innerHTML = `<p class='text-red-500 text-2xl font-bold'>連線中斷，請稍後再試。</p>`;
            }
        }

        document.getElementById('start-btn').onclick = () => {
            bgMusic.play().then(() => {
                isPlaying = true; musicIcon.classList.add('hidden'); musicBars.classList.remove('hidden'); musicText.textContent = "暫停背景音";
            }).catch(() => {});
            document.getElementById('entrance-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
            loadData();
        };

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) { if (isPlaying) bgMusic.pause(); } 
            else { if (isPlaying) bgMusic.play(); }
        });

        function setupHero() {
            if (allBooks.length === 0) return;
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            document.getElementById('hero-image').style.backgroundImage = `url('${randomBook.cover}')`;
            document.getElementById('hero-quote').textContent = randomBook.quote;
            document.getElementById('hero-book').textContent = `—— 《${randomBook.title}》`;
        }

        // 更新篩選器：改為使用 M欄位 (category) 並支援多選 (Checkboxes 行為)
        function setupFilters() {
            // 取得所有不重複的分類
            const categories = [...new Set(allBooks.flatMap(b => b.category.split(/[、,，]/).map(c => c.trim())).filter(c => c))];
            const container = document.getElementById('filter-container');
            container.innerHTML = ''; 
            
            // 產生「全部」按鈕
            const btnAll = document.createElement('button');
            btnAll.className = `filter-btn px-6 py-2 md:px-8 md:py-4 rounded-full text-sm md:text-base whitespace-nowrap transition-all border flex items-center gap-2 ${selectedCategories.size === 0 ? 'bg-stone-800 text-white border-stone-800 shadow-xl' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50 active:scale-95'}`;
            btnAll.innerHTML = `<i data-lucide="layout-grid" class="w-4 h-4 md:w-5 md:h-5"></i> 全部`;
            btnAll.onclick = () => {
                selectedCategories.clear();
                updateFilterUI();
                renderBooks();
            };
            container.appendChild(btnAll);

            // 產生各分類的勾選按鈕
            categories.forEach(cat => {
                if(cat === '未分類' && categories.length > 1) return; // 隱藏未分類(可選)

                const btn = document.createElement('button');
                btn.className = `filter-btn px-6 py-2 md:px-8 md:py-4 rounded-full text-sm md:text-base whitespace-nowrap transition-all border flex items-center gap-2 ${selectedCategories.has(cat) ? 'bg-stone-800 text-white border-stone-800 shadow-xl' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50 active:scale-95'}`;
                btn.dataset.category = cat;
                
                // 模擬 Checkbox 的視覺小圓圈與打勾圖示
                const indicatorHTML = `<div class="w-4 h-4 rounded-full border flex items-center justify-center transition-colors checkbox-indicator ${selectedCategories.has(cat) ? 'border-white bg-white text-stone-800' : 'border-current'}">
                    ${selectedCategories.has(cat) ? '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </div>`;
                
                btn.innerHTML = `${indicatorHTML} ${cat}`;
                btn.onclick = () => {
                    if (selectedCategories.has(cat)) {
                        selectedCategories.delete(cat); // 取消勾選
                    } else {
                        selectedCategories.add(cat);    // 增加勾選
                    }
                    updateFilterUI();
                    renderBooks();
                };
                container.appendChild(btn);
            });
            initIcons();
        }

        // 獨立的 UI 更新函式，讓按鈕狀態改變時不需重新建立 DOM
        function updateFilterUI() {
            const container = document.getElementById('filter-container');
            const btns = container.querySelectorAll('.filter-btn');
            
            btns.forEach((btn, index) => {
                if (index === 0) { // "全部" button
                    btn.className = `filter-btn px-6 py-2 md:px-8 md:py-4 rounded-full text-sm md:text-base whitespace-nowrap transition-all border flex items-center gap-2 ${selectedCategories.size === 0 ? 'bg-stone-800 text-white border-stone-800 shadow-xl' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50 active:scale-95'}`;
                } else {
                    const cat = btn.dataset.category;
                    const isSelected = selectedCategories.has(cat);
                    btn.className = `filter-btn px-6 py-2 md:px-8 md:py-4 rounded-full text-sm md:text-base whitespace-nowrap transition-all border flex items-center gap-2 ${isSelected ? 'bg-stone-800 text-white border-stone-800 shadow-xl' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50 active:scale-95'}`;
                    
                    const indicator = btn.querySelector('.checkbox-indicator');
                    if (indicator) {
                        indicator.className = `w-4 h-4 rounded-full border flex items-center justify-center transition-colors checkbox-indicator ${isSelected ? 'border-white bg-white text-stone-800' : 'border-current'}`;
                        indicator.innerHTML = isSelected ? '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>' : '';
                    }
                }
            });
        }

        function renderBooks() {
            const grid = document.getElementById('book-grid');
            const emptyState = document.getElementById('empty-state');
            grid.innerHTML = '';

            // 將搜尋字串用空白切分，支援多關鍵字搜尋 (例如："英文書名 作者中文名")
            const searchTerms = currentSearch.toLowerCase().trim().split(/\s+/).filter(t => t);

            const filtered = allBooks.filter(book => {
                // 1. 強化搜尋邏輯：將所有相關欄位組合在一起，確保中英文搜尋皆可命中
                const searchStr = [book.title, book.author, book.quote, book.teachingUnit, book.coreArgument, book.category].join(' ').toLowerCase();
                // 必須符合「所有」輸入的關鍵字 (AND 邏輯)
                const matchesSearch = searchTerms.length === 0 || searchTerms.every(term => searchStr.includes(term));

                // 2. 類別勾選過濾邏輯
                const bookCategories = book.category.split(/[、,，]/).map(c => c.trim());
                // 如果沒有選任何類別，就顯示全部；否則只要書本包含「任何一個」被選中的類別就顯示
                const matchesCategory = selectedCategories.size === 0 || bookCategories.some(c => selectedCategories.has(c));

                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) emptyState.classList.remove('hidden');
            else {
                emptyState.classList.add('hidden');
                filtered.forEach(book => {
                    const card = document.createElement('div');
                    card.className = "group cursor-pointer flex flex-col transition-all";
                    card.onclick = () => openModal(book);
                    card.innerHTML = `
                        <div class="relative book-card-aspect rounded-[3rem] overflow-hidden shadow-2xl transition-all duration-700 group-hover:-translate-y-4 group-hover:shadow-[0_40px_80px_rgba(0,0,0,0.3)] bg-stone-200">
                            <img src="${book.cover}" class="w-full h-full object-cover transition-scale duration-1000 group-hover:scale-110" loading="lazy">
                            <div class="absolute inset-0 bg-stone-900/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center p-12 text-center hidden lg:flex">
                                <p class="text-white text-lg font-serif italic leading-relaxed line-clamp-4">${book.quote}</p>
                            </div>
                        </div>
                        <div class="mt-8 px-4 text-center lg:text-left">
                            <h3 class="font-serif text-xl md:text-3xl font-bold text-stone-900 leading-[1.3] group-hover:text-amber-800 transition-colors">${book.title}</h3>
                            <p class="text-stone-500 text-base md:text-xl mt-4 flex items-center justify-center lg:justify-start gap-3"><i data-lucide="user" class="w-6 h-6 opacity-30"></i> ${book.author}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
            initIcons();
        }

        function openModal(book) {
            playPageSfx(); 
            document.getElementById('modal-title').textContent = book.title;
            document.getElementById('modal-author').textContent = book.author;
            document.getElementById('modal-year').textContent = book.year;
            // 在彈窗上方顯示「類別 | 教學單元」
            document.getElementById('modal-unit').textContent = (book.category && book.category !== '未分類' ? book.category + ' | ' : '') + book.teachingUnit;
            document.getElementById('modal-quote').textContent = book.quote;
            document.getElementById('modal-argument').textContent = book.coreArgument;
            document.getElementById('modal-framework').textContent = book.framework;
            document.getElementById('modal-position').textContent = book.position;
            document.getElementById('modal-teaching').textContent = book.teachingApp;
            document.getElementById('modal-cover').src = book.cover;
            
            // 處理深度導讀按鈕顯示邏輯
            const ddContainer = document.getElementById('modal-deep-dive-container');
            const ddLink = document.getElementById('modal-deep-dive-link');
            if (book.deepDive && book.deepDive.trim().startsWith('http')) {
                ddLink.href = "javascript:void(0);";
                ddLink.onclick = (e) => {
                    e.preventDefault();
                    showExternalLinkAlert(book.deepDive.trim(), "即將開啟外部導讀", "複製導讀網址");
                };
                ddContainer.classList.remove('hidden');
            } else {
                ddContainer.classList.add('hidden');
            }

            // 處理練習題按鈕顯示邏輯 (新增)
            const exContainer = document.getElementById('modal-exercise-container');
            const exLink = document.getElementById('modal-exercise-link');
            if (book.exerciseLink && book.exerciseLink.trim().startsWith('http')) {
                exLink.href = "javascript:void(0);";
                exLink.onclick = (e) => {
                    e.preventDefault();
                    showExternalLinkAlert(book.exerciseLink.trim(), "即將開啟練習題", "複製練習題網址");
                };
                exContainer.classList.remove('hidden');
            } else {
                exContainer.classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('modal-content-area').scrollTop = 0;
            initIcons();
        }

        // 修改：讓外部連結提示彈窗可接受自訂標題與按鈕文字，以共用於不同按鈕
        function showExternalLinkAlert(url, title = "即將開啟外部連結", btnText = "複製網址") {
            const modal = document.getElementById('external-link-modal');
            modal.classList.remove('hidden');
            
            // 設定標題
            document.getElementById('external-link-title').textContent = title;
            
            const btnCopy = document.getElementById('btn-copy-deep-link');
            const btnContinue = document.getElementById('btn-continue-link');
            const btnCancel = document.getElementById('btn-cancel-link');
            const overlay = document.getElementById('external-link-overlay');
            
            // 移除舊的事件監聽器，避免重複綁定
            const newBtnCopy = btnCopy.cloneNode(true);
            const newBtnContinue = btnContinue.cloneNode(true);
            const newBtnCancel = btnCancel.cloneNode(true);
            const newOverlay = overlay.cloneNode(true);
            
            btnCopy.replaceWith(newBtnCopy);
            btnContinue.replaceWith(newBtnContinue);
            btnCancel.replaceWith(newBtnCancel);
            overlay.replaceWith(newOverlay);
            
            // 設定按鈕文字
            const copySpan = newBtnCopy.querySelector('span');
            if (copySpan) copySpan.textContent = btnText;
            
            const closeAlert = () => modal.classList.add('hidden');
            
            newBtnCancel.onclick = closeAlert;
            newOverlay.onclick = closeAlert;
            
            newBtnContinue.onclick = () => {
                window.open(url, '_blank');
                closeAlert();
            };
            
            newBtnCopy.onclick = () => {
                const textArea = document.createElement("textarea");
                textArea.value = url;
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copySpan.textContent = "✨ 網址已複製！";
                    newBtnCopy.classList.remove('bg-amber-100', 'text-amber-800');
                    newBtnCopy.classList.add('bg-green-100', 'text-green-800');
                    setTimeout(() => { 
                        copySpan.textContent = btnText; // 恢復原本的文字
                        newBtnCopy.classList.add('bg-amber-100', 'text-amber-800');
                        newBtnCopy.classList.remove('bg-green-100', 'text-green-800');
                        closeAlert();
                    }, 2000);
                } catch (err) {
                    console.error('複製失敗', err);
                    alert("複製失敗，請手動複製");
                }
                document.body.removeChild(textArea);
            };
            
            initIcons(); // 重新渲染 modal 內的 icon
        }

        function closeModal() {
            playPageSfx(); 
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        musicToggle.onclick = () => {
            if (!isPlaying) {
                bgMusic.play().then(() => {
                    isPlaying = true; musicIcon.classList.add('hidden'); musicBars.classList.remove('hidden'); musicText.textContent = "暫停音樂";
                }).catch(() => {});
            } else {
                bgMusic.pause(); isPlaying = false; musicIcon.classList.remove('hidden'); musicBars.classList.add('hidden'); musicText.textContent = "開啟音樂";
            }
        };

        const bttBtn = document.getElementById('back-to-top');
        window.onscroll = () => {
            if (window.scrollY > 400) bttBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            else bttBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
        };
        bttBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        document.getElementById('modal-close').onclick = closeModal;
        document.getElementById('modal-overlay').onclick = closeModal;
        document.getElementById('search-input').oninput = (e) => { currentSearch = e.target.value; renderBooks(); };

        // 複製網址按鈕邏輯
        document.getElementById('copy-link-btn').onclick = (e) => {
            e.stopPropagation(); // 避免觸發到其他背景點擊事件
            const url = window.location.href;
            const copyTextSpan = document.getElementById('copy-link-text');
            const originalText = "複製網址 (若資料未更新，建議以無痕模式開啟)";
            
            // 建立暫時的 textarea 來執行複製 (相容性較好，確保在各種環境都能運作)
            const textArea = document.createElement("textarea");
            textArea.value = url;
            // 確保元素不在畫面上造成突兀閃爍
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                copyTextSpan.textContent = "✨ 網址已成功複製！";
                copyTextSpan.classList.add('text-amber-200');
                
                // 2.5秒後恢復原狀
                setTimeout(() => { 
                    copyTextSpan.textContent = originalText; 
                    copyTextSpan.classList.remove('text-amber-200');
                }, 2500);
            } catch (err) {
                console.error('複製失敗', err);
                copyTextSpan.textContent = "複製失敗，請手動複製上方網址列";
                setTimeout(() => { copyTextSpan.textContent = originalText; }, 2500);
            }
            document.body.removeChild(textArea);
        };

        document.body.style.overflow = 'hidden';
        window.onload = initIcons;
    </script>
</body>
</html>