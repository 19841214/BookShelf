<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ä½æ›¸æ«ƒï¼šè¦–è¦ºåŒ–æ•™å­¸è³‡æºç¶²</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Noto Serif & Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        
        html { scroll-behavior: smooth; }
        .book-card-aspect { aspect-ratio: 2/3; }

        .music-bar {
            width: 2px; height: 12px; background: #fde68a; margin: 0 1px;
            animation: music-wave 1s ease-in-out infinite; display: inline-block;
        }
        .music-bar:nth-child(2) { animation-delay: 0.2s; }
        .music-bar:nth-child(3) { animation-delay: 0.4s; }
        @keyframes music-wave { 0%, 100% { height: 4px; } 50% { height: 16px; } }

        #entrance-overlay { background-image: radial-gradient(circle at center, #1c1917 0%, #0c0a09 100%); }
        #modal-content-area { scrollbar-gutter: stable; }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f5f5f4; }
        #modal-content-area::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; border: 3px solid #f5f5f4; }
        #modal-content-area::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 transition-colors duration-500 overflow-x-hidden">

    <!-- é€²å…¥é é¢é–€æª» -->
    <div id="entrance-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center text-white px-6 text-center">
        <div class="mb-12 animate-in fade-in zoom-in duration-1000">
            <i data-lucide="book-marked" class="w-16 h-16 mx-auto mb-6 text-amber-200/60"></i>
            <h1 class="text-4xl md:text-7xl font-serif font-bold tracking-[0.3em] mb-4">æ•¸ä½æ›¸æ«ƒ</h1>
            <p class="text-stone-500 tracking-[0.5em] font-light text-xs md:text-lg uppercase">Visualized Teaching Resources</p>
        </div>
        <button id="start-btn" class="group relative px-12 py-5 bg-white/5 hover:bg-white/10 border border-white/20 rounded-full overflow-hidden transition-all hover:scale-105 active:scale-95 shadow-2xl">
            <span class="relative z-10 text-xl tracking-[0.4em] font-serif group-hover:text-amber-200 transition-colors">é–‹å•Ÿæ›¸å·ï¼Œéœå¿ƒé–±è®€</span>
            <div class="absolute inset-0 bg-gradient-to-r from-amber-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </button>
    </div>

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-stone-50 hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin mb-4"></div>
        <p class="font-serif tracking-widest text-lg text-stone-600 font-bold italic">å¢¨é¦™æ¸²æŸ“ä¸­...</p>
    </div>

    <!-- éŸ³è¨Šè³‡æº -->
    <audio id="bg-music" loop preload="auto"><source src="https://cdn.pixabay.com/download/audio/2025/06/06/audio_cd7be0eafc.mp3?filename=tunetank-ambient-piano-music-348968.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-page" preload="auto"><source src="https://cdn.pixabay.com/download/audio/2025/11/25/audio_26e276330f.mp3?filename=spinopel-turn-the-page-of-a-book-442331.mp3" type="audio/mpeg"></audio>

    <section id="hero" class="relative h-[65vh] md:h-[85vh] flex items-center justify-center overflow-hidden bg-stone-900 text-white">
        <div id="hero-image" class="absolute inset-0 opacity-30 bg-cover bg-center blur-sm scale-105 transition-all duration-1000"></div>
        <div class="relative z-10 text-center px-6 max-w-6xl">
            <i data-lucide="sparkles" class="mx-auto mb-4 md:mb-6 text-amber-200 opacity-80 w-6 h-6 md:w-10 md:h-10"></i>
            <h2 id="hero-quote" class="text-xl md:text-5xl font-serif italic mb-8 md:mb-14 leading-relaxed tracking-wide px-4"></h2>
            <div class="h-px w-16 md:w-32 bg-amber-200 mx-auto mb-8 opacity-50"></div>
            <p id="hero-book" class="text-stone-300 font-light tracking-[0.2em] text-sm md:text-2xl mb-12"></p>
            
            <div class="flex flex-wrap items-center justify-center gap-6">
                <button id="music-toggle" class="inline-flex items-center gap-3 px-10 py-4 bg-amber-200/10 hover:bg-amber-200/20 backdrop-blur-md border border-amber-200/30 rounded-full text-sm md:text-lg tracking-[0.2em] transition-all hover:scale-105 active:scale-95 group">
                    <div id="music-bars" class="hidden flex items-end h-5"><span class="music-bar"></span><span class="music-bar"></span><span class="music-bar"></span></div>
                    <i id="music-icon" data-lucide="music" class="w-5 h-5 text-amber-200"></i>
                    <span id="music-text">æš«åœéŸ³æ¨‚</span>
                </button>
            </div>
        </div>
    </section>

    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-stone-200 shadow-sm">
        <div class="max-w-[1600px] mx-auto flex flex-col gap-4 p-4 md:p-8">
            <div class="flex flex-col md:flex-row gap-6 items-center justify-between">
                <div class="relative w-full md:w-[500px]">
                    <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 text-stone-400 w-6 h-6"></i>
                    <input type="text" id="search-input" placeholder="æœå°‹æ›¸åã€ä½œè€…ã€é‡‘å¥æˆ–æ•™å­¸å–®å…ƒ..." class="w-full pl-16 pr-6 py-4 bg-stone-100 border-transparent focus:bg-white border focus:border-stone-300 rounded-2xl focus:outline-none transition-all text-base md:text-xl appearance-none shadow-inner">
                </div>
            </div>
            <div class="flex items-center gap-3 overflow-x-auto no-scrollbar py-2">
                <i data-lucide="filter" class="text-stone-400 flex-shrink-0 w-5 h-5 mr-2 hidden md:block"></i>
                <div id="filter-container" class="flex gap-4"></div>
            </div>
        </div>
    </div>

    <main class="max-w-[1600px] mx-auto px-6 mt-10 mb-32">
        <div id="book-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8 md:gap-16"></div>
        <div id="empty-state" class="hidden py-40 text-center text-stone-400">
            <i data-lucide="book-open" class="mx-auto mb-6 opacity-20 w-24 h-24"></i>
            <p class="text-2xl font-light">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å…§å®¹</p>
        </div>
    </main>

    <!-- è¶…å¤§è©³æƒ…å½ˆçª— -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-0 md:p-2 lg:p-4">
        <div id="modal-overlay" class="absolute inset-0 bg-stone-900/95 backdrop-blur-2xl"></div>
        
        <div class="relative bg-white w-full h-full md:w-[98vw] md:h-[96vh] md:rounded-[3rem] overflow-hidden shadow-[0_0_120px_rgba(0,0,0,0.6)] animate-in zoom-in-95 duration-500 flex flex-col md:flex-row">
            
            <button id="modal-close" class="absolute top-4 right-4 md:top-6 md:right-6 z-[60] p-3 md:p-5 bg-stone-900/40 hover:bg-stone-900/60 md:bg-stone-900/20 md:hover:bg-stone-900/40 rounded-full text-white backdrop-blur-xl transition-all shadow-2xl">
                <i data-lucide="x" class="w-6 h-6 md:w-12 md:h-12"></i>
            </button>
            
            <div class="relative w-full h-[30vh] md:h-full md:w-[35%] bg-stone-200 flex-shrink-0 transition-all duration-300" id="modal-left-panel">
                <div class="absolute inset-x-0 top-0 h-24 bg-gradient-to-b from-stone-900/60 to-transparent md:hidden z-10 pointer-events-none"></div>
                <img id="modal-cover" src="" alt="" class="w-full h-full object-cover object-top md:object-center shadow-2xl relative z-0">
            </div>

            <div id="modal-content-area" class="w-full flex-1 md:w-[65%] md:h-full p-6 md:p-24 overflow-y-auto bg-stone-50 transition-all duration-300 relative">
                
                <div id="original-modal-content">
                    <div class="mb-10 md:mb-20">
                        <span id="modal-unit" class="text-amber-600 text-sm md:text-2xl font-bold tracking-[0.4em] uppercase mb-4 md:mb-6 block"></span>
                        <h2 id="modal-title" class="text-3xl md:text-6xl font-serif font-bold text-stone-900 mb-4 md:mb-6 leading-[1.2]"></h2>
                        <div class="flex flex-wrap items-center gap-6 md:gap-12 text-stone-400 text-sm md:text-3xl font-light mb-8 md:mb-10">
                            <span class="flex items-center gap-2 md:gap-4"><i data-lucide="user" class="w-5 h-5 md:w-10 md:h-10 opacity-30"></i> <span id="modal-author" class="text-stone-600"></span></span>
                            <span class="flex items-center gap-2 md:gap-4"><i data-lucide="calendar" class="w-5 h-5 md:w-10 md:h-10 opacity-30"></i> <span id="modal-year" class="text-stone-600"></span></span>
                        </div>

                        <!-- æ·±åº¦å°è®€æŒ‰éˆ•å€å¡Š -->
                        <div id="modal-deep-dive-container" class="hidden">
                            <button id="modal-deep-dive-btn" class="inline-flex items-center gap-3 md:gap-4 px-6 md:px-8 py-3 md:py-4 bg-stone-800 hover:bg-stone-700 text-white rounded-xl md:rounded-2xl text-base md:text-2xl font-bold transition-all shadow-xl active:scale-95 group">
                                <i data-lucide="external-link" class="w-5 h-5 md:w-8 md:h-8 group-hover:text-amber-200 transition-colors"></i>
                                é–±è®€æ·±åº¦è§£æ (Google Doc)
                            </button>
                        </div>
                    </div>

                    <div class="space-y-16 md:space-y-32 text-stone-700 pb-12 md:pb-20">
                        <div class="relative p-8 md:p-24 bg-white rounded-3xl md:rounded-[4rem] border-l-[12px] md:border-l-[24px] border-stone-800 shadow-2xl italic group overflow-hidden">
                            <i data-lucide="quote" class="absolute -top-6 -left-6 md:-top-12 md:-left-10 text-stone-50 w-32 h-32 md:w-64 md:h-64 opacity-60"></i>
                            <p id="modal-quote" class="leading-[1.6] font-serif text-xl md:text-4xl relative z-10 text-stone-800"></p>
                        </div>
                        <section>
                            <h4 class="flex items-center gap-4 md:gap-6 text-stone-900 font-bold mb-6 md:mb-10 border-b-4 border-stone-200 pb-4 md:pb-6 text-xl md:text-4xl">
                                <i data-lucide="sparkles" class="text-amber-500 w-6 h-6 md:w-14 md:h-14"></i> æ ¸å¿ƒè«–é»
                            </h4>
                            <p id="modal-argument" class="text-lg md:text-3xl leading-[2] text-stone-600 font-light"></p>
                        </section>
                        <div class="space-y-12 md:space-y-24">
                            <section>
                                <h4 class="text-stone-900 font-bold mb-4 md:mb-8 text-xs md:text-xl uppercase tracking-[0.5em] opacity-30">ç†è«–æ¶æ§‹ / ç ”ç©¶æ–¹æ³•</h4>
                                <p id="modal-framework" class="text-base md:text-3xl leading-[1.8] text-stone-600 bg-stone-200/40 p-6 md:p-14 rounded-3xl md:rounded-[3rem] border border-stone-200/50"></p>
                            </section>
                            <section>
                                <h4 class="text-stone-900 font-bold mb-4 md:mb-8 text-xs md:text-xl uppercase tracking-[0.5em] opacity-30">å­¸è¡“å®šä½</h4>
                                <p id="modal-position" class="text-base md:text-3xl leading-[1.8] text-stone-600 bg-stone-200/40 p-6 md:p-14 rounded-3xl md:rounded-[3rem] border border-stone-200/50"></p>
                            </section>
                        </div>
                        <section class="bg-amber-50 p-8 md:p-24 rounded-3xl md:rounded-[4rem] border border-amber-100 shadow-inner">
                            <h4 class="flex items-center gap-4 md:gap-8 text-amber-900 font-bold mb-6 md:mb-12 text-2xl md:text-5xl">
                                <i data-lucide="graduation-cap" class="text-amber-700 w-8 h-8 md:w-20 md:h-20"></i> æ•™å­¸æ‡‰ç”¨å»ºè­°
                            </h4>
                            <p id="modal-teaching" class="text-lg md:text-3xl leading-[2] whitespace-pre-wrap text-stone-800 font-normal"></p>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã€æ–°å¢ã€‘é˜²å‘†æç¤ºå½ˆçª— (æ””æˆª GAS è¡çªç”¨) -->
    <div id="gas-warning-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm" id="gas-warning-overlay"></div>
        <div class="relative bg-white rounded-3xl shadow-2xl max-w-lg w-full p-8 animate-in zoom-in-95 duration-200">
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-amber-100 p-3 rounded-full text-amber-600">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-bold text-stone-800 font-serif">å³å°‡å‰å¾€æ·±åº¦è§£æ</h3>
            </div>
            <p class="text-stone-600 mb-6 leading-relaxed text-lg">
                é€™æ˜¯ä¸€ä»½ Google Apps Script æ–‡ä»¶ã€‚å¦‚æœé»æ“Šå¾Œå‡ºç¾<strong class="text-red-500">ã€Œç„¡æ³•é–‹å•Ÿæª”æ¡ˆã€</strong>çš„éŒ¯èª¤ç•«é¢ï¼Œé€šå¸¸æ˜¯å› ç‚ºæ‚¨çš„ç€è¦½å™¨ç™»å…¥äº†å¤šå€‹ Google å¸³è™Ÿç”¢ç”Ÿè¡çªã€‚
            </p>
            <div class="bg-stone-50 p-4 rounded-xl border border-stone-200 mb-8 text-stone-600 text-sm space-y-2">
                <p>ğŸ’¡ <span class="font-bold">è§£æ±ºå»ºè­°ï¼š</span></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>å»ºè­°ä½¿ç”¨ <strong>ç„¡ç—•è¦–çª—</strong> é–‹å•Ÿ</li>
                    <li>æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½ç¶²å€ï¼Œè²¼åˆ° <strong>LINE</strong> è£¡é¢é–‹å•Ÿ</li>
                </ul>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="btn-copy-link" class="flex-1 flex justify-center items-center gap-2 py-3 px-4 bg-stone-100 hover:bg-stone-200 text-stone-700 rounded-xl font-bold transition-colors">
                    <i data-lucide="copy" class="w-5 h-5"></i> è¤‡è£½é€£çµ
                </button>
                <button id="btn-proceed" class="flex-1 flex justify-center items-center gap-2 py-3 px-4 bg-stone-800 hover:bg-stone-700 text-white rounded-xl font-bold transition-colors">
                    ç›´æ¥å‰å¾€ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
            <button id="btn-cancel-warning" class="absolute top-4 right-4 text-stone-400 hover:text-stone-600 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- æˆåŠŸè¤‡è£½åå¸æç¤º -->
    <div id="toast-copy" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-[110] flex items-center gap-2 font-bold">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i> å·²è¤‡è£½é€£çµï¼è«‹è‡³ LINE æˆ–ç„¡ç—•è¦–çª—è²¼ä¸Šã€‚
    </div>

    <button id="back-to-top" class="fixed bottom-6 right-6 md:bottom-12 md:right-12 z-30 p-4 md:p-6 bg-stone-800 text-white rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none hover:bg-stone-700">
        <i data-lucide="arrow-up" class="w-8 h-8 md:w-10 md:h-10"></i>
    </button>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_cqaP-vZr1MW-RYFmbWsCD9FKEwRDXq8lHjI12Sl5z0VwfnvQgurnhE3PDVXrK1cqMRhaMLKVx9XG/pub?gid=1650364862&single=true&output=csv";
        
        let allBooks = [];
        let currentFilter = 'å…¨éƒ¨';
        let currentSearch = '';
        let pendingGasUrl = ''; // ç”¨ä¾†æš«å­˜è¦é–‹å•Ÿçš„ç¶²å€

        const bgMusic = document.getElementById('bg-music');
        const pageSfx = document.getElementById('sfx-page');
        const musicToggle = document.getElementById('music-toggle');
        const musicIcon = document.getElementById('music-icon');
        const musicText = document.getElementById('music-text');
        const musicBars = document.getElementById('music-bars');
        let isPlaying = false;

        const initIcons = () => lucide.createIcons();
        const playPageSfx = () => { pageSfx.currentTime = 0; pageSfx.play().catch(() => {}); };

        function robustCSVParse(text) {
            const rows = [];
            let currentField = ''; let currentRow = []; let inQuotes = false;
            const normalizedText = text.replace(/\r\n/g, '\n');

            for (let i = 0; i < normalizedText.length; i++) {
                const char = normalizedText[i]; const nextChar = normalizedText[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; } 
                    else if (char === '"') { inQuotes = false; } 
                    else { currentField += char; }
                } else {
                    if (char === '"') { inQuotes = true; } 
                    else if (char === ',') { currentRow.push(currentField); currentField = ''; } 
                    else if (char === '\n') {
                        currentRow.push(currentField);
                        if (currentRow.length > 1 || currentRow[0] !== '') { rows.push(currentRow); }
                        currentRow = []; currentField = '';
                    } else { currentField += char; }
                }
            }
            if (currentRow.length > 0 || currentField !== '') { currentRow.push(currentField); rows.push(currentRow); }
            return rows.slice(1);
        }

        async function loadData() {
            document.getElementById('loading-screen').classList.remove('hidden');
            try {
                const response = await fetch(SHEET_CSV_URL);
                const text = await response.text();
                const data = robustCSVParse(text);

                allBooks = data.map((row, index) => ({
                    id: index,
                    title: row[0] || 'æœªçŸ¥æ›¸å',
                    author: row[1] || 'æœªçŸ¥ä½œè€…',
                    year: row[2] || '',
                    coreArgument: row[3] || '',
                    quote: row[4] || '',
                    framework: row[5] || '',
                    position: row[6] || '',
                    teachingUnit: row[7] || 'æœªåˆ†é¡',
                    teachingApp: row[8] || '',
                    cover: row[9] || 'https://images.unsplash.com/photo-1543004218-ee141104975a?auto=format&fit=crop&q=80&w=400',
                    deepDive: row[10] || '' 
                }));

                setupHero(); setupFilters(); renderBooks();
                document.getElementById('loading-screen').classList.add('hidden');
            } catch (error) {
                console.error("Data Fetch Error:", error);
                document.getElementById('loading-screen').innerHTML = `<p class='text-red-500 text-2xl font-bold'>é€£ç·šä¸­æ–·ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            }
        }

        document.getElementById('start-btn').onclick = () => {
            bgMusic.play().then(() => {
                isPlaying = true; musicIcon.classList.add('hidden'); musicBars.classList.remove('hidden'); musicText.textContent = "æš«åœèƒŒæ™¯éŸ³";
            }).catch(() => {});
            document.getElementById('entrance-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
            loadData();
        };

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) { if (isPlaying) bgMusic.pause(); } 
            else { if (isPlaying) bgMusic.play(); }
        });

        function setupHero() {
            if (allBooks.length === 0) return;
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            document.getElementById('hero-image').style.backgroundImage = `url('${randomBook.cover}')`;
            document.getElementById('hero-quote').textContent = randomBook.quote;
            document.getElementById('hero-book').textContent = `â€”â€” ã€Š${randomBook.title}ã€‹`;
        }

        function setupFilters() {
            const units = ['å…¨éƒ¨', ...new Set(allBooks.flatMap(b => b.teachingUnit.split(/[ã€,ï¼Œ]/).map(u => u.trim())).filter(u => u))];
            const container = document.getElementById('filter-container');
            container.innerHTML = ''; 
            units.forEach(unit => {
                const btn = document.createElement('button');
                btn.className = `filter-btn px-8 py-4 rounded-full text-base whitespace-nowrap transition-all border ${unit === 'å…¨éƒ¨' ? 'bg-stone-800 text-white border-stone-800 shadow-xl' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50 active:scale-95'}`;
                btn.textContent = unit;
                btn.onclick = () => {
                    currentFilter = unit;
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('bg-stone-800', 'text-white', 'border-stone-800', 'shadow-xl');
                        b.classList.add('bg-white', 'text-stone-500', 'border-stone-200');
                    });
                    btn.classList.add('bg-stone-800', 'text-white', 'border-stone-800', 'shadow-xl');
                    renderBooks();
                };
                container.appendChild(btn);
            });
        }

        function renderBooks() {
            const grid = document.getElementById('book-grid');
            const emptyState = document.getElementById('empty-state');
            grid.innerHTML = '';
            const filtered = allBooks.filter(book => {
                const searchStr = (book.title + book.author + book.quote + book.teachingUnit + book.coreArgument).toLowerCase();
                return searchStr.includes(currentSearch.toLowerCase()) && (currentFilter === 'å…¨éƒ¨' || book.teachingUnit.includes(currentFilter));
            });
            if (filtered.length === 0) emptyState.classList.remove('hidden');
            else {
                emptyState.classList.add('hidden');
                filtered.forEach(book => {
                    const card = document.createElement('div');
                    card.className = "group cursor-pointer flex flex-col transition-all";
                    card.onclick = () => openModal(book);
                    card.innerHTML = `
                        <div class="relative book-card-aspect rounded-[3rem] overflow-hidden shadow-2xl transition-all duration-700 group-hover:-translate-y-4 group-hover:shadow-[0_40px_80px_rgba(0,0,0,0.3)] bg-stone-200">
                            <img src="${book.cover}" class="w-full h-full object-cover transition-scale duration-1000 group-hover:scale-110" loading="lazy">
                            <div class="absolute inset-0 bg-stone-900/80 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center p-12 text-center hidden lg:flex">
                                <p class="text-white text-lg font-serif italic leading-relaxed line-clamp-4">${book.quote}</p>
                            </div>
                        </div>
                        <div class="mt-8 px-4 text-center lg:text-left">
                            <h3 class="font-serif text-xl md:text-3xl font-bold text-stone-900 leading-[1.3] group-hover:text-amber-800 transition-colors">${book.title}</h3>
                            <p class="text-stone-500 text-base md:text-xl mt-4 flex items-center justify-center lg:justify-start gap-3"><i data-lucide="user" class="w-6 h-6 opacity-30"></i> ${book.author}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
            initIcons();
        }

        function openModal(book) {
            playPageSfx(); 
            document.getElementById('modal-title').textContent = book.title;
            document.getElementById('modal-author').textContent = book.author;
            document.getElementById('modal-year').textContent = book.year;
            document.getElementById('modal-unit').textContent = book.teachingUnit;
            document.getElementById('modal-quote').textContent = book.quote;
            document.getElementById('modal-argument').textContent = book.coreArgument;
            document.getElementById('modal-framework').textContent = book.framework;
            document.getElementById('modal-position').textContent = book.position;
            document.getElementById('modal-teaching').textContent = book.teachingApp;
            document.getElementById('modal-cover').src = book.cover;
            
            const ddContainer = document.getElementById('modal-deep-dive-container');
            const ddBtn = document.getElementById('modal-deep-dive-btn');
            
            if (book.deepDive && book.deepDive.trim().startsWith('http')) {
                ddContainer.classList.remove('hidden');
                ddBtn.onclick = () => {
                    // ã€é‡é»æ›´æ–°ã€‘ä¸ç›´æ¥é–‹æ–°åˆ†é ï¼Œå…ˆå½ˆå‡ºé˜²å‘†æç¤ºï¼Œä¸¦è¨˜éŒ„ç¶²å€
                    pendingGasUrl = book.deepDive.trim();
                    document.getElementById('gas-warning-modal').classList.remove('hidden');
                };
            } else {
                ddContainer.classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('modal-content-area').scrollTop = 0;
            initIcons();
        }

        function closeModal() {
            playPageSfx(); 
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // --- é˜²å‘†æç¤ºå½ˆçª—é‚è¼¯ ---
        const hideWarningModal = () => document.getElementById('gas-warning-modal').classList.add('hidden');
        
        document.getElementById('btn-cancel-warning').onclick = hideWarningModal;
        document.getElementById('gas-warning-overlay').onclick = hideWarningModal;
        
        // ç›´æ¥å‰å¾€æŒ‰éˆ•
        document.getElementById('btn-proceed').onclick = () => {
            window.open(pendingGasUrl, '_blank');
            hideWarningModal();
        };

        // è¤‡è£½é€£çµæŒ‰éˆ•
        document.getElementById('btn-copy-link').onclick = () => {
            const tempInput = document.createElement("input");
            tempInput.value = pendingGasUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            
            // é¡¯ç¤ºæˆåŠŸ Toast
            const toast = document.getElementById('toast-copy');
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
            hideWarningModal();
        };
        // -------------------------

        musicToggle.onclick = () => {
            if (!isPlaying) {
                bgMusic.play().then(() => {
                    isPlaying = true; musicIcon.classList.add('hidden'); musicBars.classList.remove('hidden'); musicText.textContent = "æš«åœéŸ³æ¨‚";
                }).catch(() => {});
            } else {
                bgMusic.pause(); isPlaying = false; musicIcon.classList.remove('hidden'); musicBars.classList.add('hidden'); musicText.textContent = "é–‹å•ŸéŸ³æ¨‚";
            }
        };

        const bttBtn = document.getElementById('back-to-top');
        window.onscroll = () => {
            if (window.scrollY > 400) bttBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            else bttBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
        };
        bttBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        document.getElementById('modal-close').onclick = closeModal;
        document.getElementById('modal-overlay').onclick = closeModal;
        document.getElementById('search-input').oninput = (e) => { currentSearch = e.target.value; renderBooks(); };

        document.body.style.overflow = 'hidden';
        window.onload = initIcons;
    </script>
</body>
</html>